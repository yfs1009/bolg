import{bundledLanguages as E,isSpecialLang as H,createHighlighter as P}from"shiki";import{bundledLanguages as we}from"shiki";import{resolveWhitespacePosition as T,lineNumbers as x,collapsedLines as C}from"@vuepress/highlighter-helper";import{isPlainObject as j}from"vuepress/shared";import{Logger as M,getRealPath as p}from"@vuepress/helper";import{customAlphabet as F}from"nanoid";import{transformerNotationDiff as D,transformerNotationFocus as O,transformerNotationHighlight as R,transformerNotationErrorLevel as S,transformerNotationWordHighlight as q,transformerMetaWordHighlight as _,transformerRenderWhitespace as G,transformerCompactLineOptions as I}from"@shikijs/transformers";import{colors as v}from"vuepress/utils";const L=Object.keys(E),U=/\[\\!code/g,z={name:"vuepress:add-class",pre(e){this.addClassToHast(e,"vp-code")}},B={name:"vuepress:cleanup",pre(e){delete e.properties.tabindex}},J={name:"vuepress:remove-escape",postprocess(e){return e.replace(U,"[!code")}},K={name:"vuepress:empty-line",code(e){e.children.forEach(s=>{s.type==="element"&&s.tagName==="span"&&Array.isArray(s.properties.class)&&s.properties.class.includes("line")&&s.children.length===0&&s.children.push({type:"element",tagName:"wbr",properties:{},children:[]})})}},Q=e=>{const s=[];return e.notationDiff&&s.push(D()),e.notationFocus&&s.push(O({classActiveLine:"has-focus",classActivePre:"has-focused-lines"})),e.notationHighlight&&s.push(R()),e.notationErrorLevel&&s.push(S()),e.notationWordHighlight&&(s.push(q()),s.push(_())),s.push(z,B,J,K),s},V=(e,s=!1)=>{const t=T(e,s);return t===!1?[]:[G({position:t})]},X=/-vue$/,y="@vuepress/plugin-shiki",b=new M(y),Y=F("abcdefghijklmnopqrstuvwxyz",10),w=e=>e.match(/^([^ :[{]+)/)?.[1]?.replace(X,"").toLowerCase()??"",Z=(e,s)=>{const t=`\\b${s}\\s*=\\s*(?<quote>['"])(?<content>.+?)\\k<quote>(\\s|$)`,r=new RegExp(t,"i");return e.match(r)?.groups?.content??null},ee=e=>{const s=e.replace(/^(?:\[.*?\])?.*?([\d,-]+).*/,"$1").trim(),t=[];return s?(s.split(",").map(r=>r.split("-").map(n=>parseInt(n,10))).forEach(([r,n])=>{r&&n?t.push(...Array.from({length:n-r+1},(i,o)=>r+o)):t.push(r)}),t.map(r=>({line:r,classes:["highlighted"]}))):[]},se=e=>{const s={},t=e.render.bind(e);return e.render=(r,n)=>(s.path=n.filePathRelative,t(r,n)),()=>s.path||"dynamic pages"},k=new Set,te=(e,s,t,r,n)=>{let i=w(e);return i&&!s.includes(i)&&!H(i)&&(r!=="silent"&&!k.has(i)&&(b.warn(`Missing ${v.cyan(e)} highlighter, ${t?`use ${v.cyan(t)} to highlight instead.`:"skip highlighting"}`),k.add(i)),r==="debug"&&b.info(`Unknown language ${v.cyan(i)} found in ${v.cyan(n())}`),i=t||"plain"),i},re=/\{\{[^]*?\}\}/g,ne=(e,s)=>e.replace(re,t=>{let r=s.get(t);return r||(r=Y(),s.set(t,r)),r}),ie=(e,s)=>{let t=e;return s.forEach((r,n)=>{t=t.replaceAll(r,n)}),t},oe=(e,s)=>{const t=new Map;return ie(s(ne(e,t).trimEnd()),t)},ae=async(e,s,{langs:t=L,langAlias:r={},defaultLang:n,transformers:i=[],...o}={})=>{const l=o.logLevel??(s.env.isDebug?"debug":"warn"),c=l==="debug"?se(e):null,g=await P({langs:t,langAlias:r,themes:"themes"in o?Object.values(o.themes):[o.theme??"nord"]});await o.shikiSetup?.(g);const a=Q(o),u=g.getLoadedLanguages();e.options.highlight=(m,d,f)=>oe(m,$=>g.codeToHtml($,{lang:te(d,u,n,l,c),meta:{__raw:f},transformers:[...a,...o.highlightLines??!0?[I(ee(f))]:[],...V(f,o.whitespace),...i],..."themes"in o?{themes:o.themes,defaultColor:!1}:{theme:o.theme??"nord"}}))},N=/{([\d,-]+)}/,le=e=>{const s=e.renderer.rules.fence;e.renderer.rules.fence=(...t)=>{const[r,n]=t,i=r[n],o=i.info||"",l=o.match(N);if(!l)return s(...t);i.info=o.replace(N,"").trim();const c=l[1];return i.info+=` ${c}`,s(...t)}},pe=/<pre([\s\S]*?)style="([^"]*)"([^>]*)>/,he=(e,{preWrapper:s=!0}={})=>{const t=e.renderer.rules.fence;e.renderer.rules.fence=(...r)=>{let n=t(...r);if(!n.startsWith("<pre"))return n;const[i,o,l]=r,c=i[o],g=c.info?e.utils.unescapeAll(c.info).trim():"",a=w(g),u=`${l.langPrefix}${a}`;if(!s)return n=n.replace(/<code[^]*?>/,"<code>"),n=`<pre class="${u}"${n.slice(4)}`,n;const m=Z(g,"title")||a;let d="";return n=n.replace(pe,(f,$,A,W)=>(d=A.trim(),`<pre ${$.trim()}${W.trimEnd()}>`)),`<div class="${u}" data-highlighter="shiki" data-ext="${a}" data-title="${m}" style="${d}">${n}</div>`}},{url:h}=import.meta,ce=(e,{lineNumbers:s=!0,highlightLines:t=!0,collapsedLines:r="disable",notationDiff:n,notationErrorLevel:i,notationFocus:o,notationHighlight:l,notationWordHighlight:c,whitespace:g})=>{const a=[`import "${p("@vuepress/highlighter-helper/styles/base.css",h)}"`,`import "${p(`${y}/styles/shiki.css`,import.meta.url)}"`],u=[];s!=="disable"&&a.push(`import "${p("@vuepress/highlighter-helper/styles/line-numbers.css",h)}"`),(t||l)&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-highlight.css",h)}"`),n&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-diff.css",h)}"`),i&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-error-level.css",h)}"`),o&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-focus.css",h)}"`),l&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-highlight.css",h)}"`),c&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-word-highlight.css",h)}"`),g&&a.push(`import "${p("@vuepress/highlighter-helper/styles/whitespace.css",h)}"`),r!=="disable"&&(a.push(`import "${p("@vuepress/highlighter-helper/styles/collapsed-lines.css",h)}"`,`import { setupCollapsedLines } from "${p("@vuepress/highlighter-helper/composables/collapsedLines.js",h)}"`),u.push("setupCollapsedLines()"));let m=a.join(`
`);return u.length&&(m+=`

export default {
  setup() {
    ${u.join(`
    `)}
  }
}
`),e.writeTemp("shiki/config.js",m)},ge=(e={})=>{const s={preWrapper:!0,lineNumbers:!0,collapsedLines:"disable",...e};return{name:"@vuepress/plugin-shiki",extendsMarkdown:async(t,r)=>{const{code:n}=r.options.markdown;await ae(t,r,{...j(n)?n:{},...e});const{preWrapper:i,lineNumbers:o,collapsedLines:l}=s;t.use(le),t.use(he,{preWrapper:i}),i&&(t.use(x,{lineNumbers:o}),t.use(C,{collapsedLines:l}))},clientConfigFile:t=>ce(t,s)}};export{L as bundledLanguageNames,we as bundledLanguages,ge as shikiPlugin};
//# sourceMappingURL=index.js.map
